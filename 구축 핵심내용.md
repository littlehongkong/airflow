# ğŸ§­ EODHD ê¸°ë°˜ ë°ì´í„° íŒŒì´í”„ë¼ì¸ í•µì‹¬ ìš”ì•½ (2025-10 ê¸°ì¤€)

## âš™ï¸ ì‹œìŠ¤í…œ ê°œìš”

| í•­ëª©      | ë‚´ìš©                                        |
| ------- | ----------------------------------------- |
| ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ | **Apache Airflow 3.1.0 (CeleryExecutor)** |
| ì¸í”„ë¼     | AWS ECS Fargate (ê°œë°œ: Docker Compose)      |
| DB      | AWS RDS PostgreSQL                        |
| ìºì‹œ/í    | AWS ElastiCache Redis                     |
| ë°ì´í„° ì†ŒìŠ¤  | [EODHD API](https://eodhd.com)            |
| ê²€ì¦ ë„êµ¬   | **Pandera + Soda Core (DuckDB ê¸°ë°˜)**       |
| ì•Œë¦¼      | Slack Webhook ì˜ˆì •                          |
| CI/CD   | AWS CodePipeline + ECR                    |

---

## ğŸ—‚ï¸ ì£¼ìš” ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
airflow/
â”œâ”€â”€ dags/equity/
â”‚   â”œâ”€â”€ us_equity_bulk_price_dag.py
â”‚   â”œâ”€â”€ kr_equity_bulk_price_dag.py
â”‚   â”œâ”€â”€ fundamental_dag.py
â”‚   â”œâ”€â”€ dividend_dag.py          # ğŸ“ì‹ ê·œ
â”‚   â””â”€â”€ split_dag.py             # ğŸ“ì‹ ê·œ
â”‚
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ hooks/eodhd_hook.py
â”‚   â”œâ”€â”€ pipelines/
â”‚   â”‚   â”œâ”€â”€ base_equity_pipeline.py
â”‚   â”‚   â”œâ”€â”€ equity_price_pipeline.py
â”‚   â”‚   â”œâ”€â”€ symbol_list_pipeline.py
â”‚   â”‚   â”œâ”€â”€ fundamental_pipeline.py
â”‚   â”‚   â”œâ”€â”€ dividend_pipeline.py   # ğŸ“ì‹ ê·œ
â”‚   â”‚   â””â”€â”€ split_pipeline.py      # ğŸ“ì‹ ê·œ
â”‚   â”œâ”€â”€ validators/
â”‚   â”‚   â”œâ”€â”€ base_validator.py
â”‚   â”‚   â”œâ”€â”€ equity_price_validator.py
â”‚   â”‚   â”œâ”€â”€ fundamental_validator.py
â”‚   â”‚   â”œâ”€â”€ dividend_validator.py  # ğŸ“ì‹ ê·œ
â”‚   â”‚   â””â”€â”€ split_validator.py     # ğŸ“ì‹ ê·œ
â”‚   â”œâ”€â”€ soda/checks/
â”‚   â”‚   â”œâ”€â”€ fundamentals_stock_checks.yml
â”‚   â”‚   â”œâ”€â”€ dividends_checks.yml   # ğŸ“ì‹ ê·œ
â”‚   â”‚   â””â”€â”€ splits_checks.yml      # ğŸ“ì‹ ê·œ
â”‚   â”œâ”€â”€ operators/pipeline_operator.py
â”‚   â””â”€â”€ utils/{interface,pipeline_helper,logger}.py
â””â”€â”€ docker-compose.yaml
```

---

## ğŸ§© íŒŒì´í”„ë¼ì¸ ì„¤ê³„ ê°œë…

ëª¨ë“  íŒŒì´í”„ë¼ì¸ì€ `DataPipelineInterface`ë¥¼ ìƒì†ë°›ìœ¼ë©°
`fetch â†’ validate â†’ load` 3ë‹¨ê³„ êµ¬ì¡°ë¡œ í†µì¼ë©ë‹ˆë‹¤.

```python
class DataPipelineInterface(ABC):
    @abstractmethod
    def fetch(self, **kwargs): ...
    @abstractmethod
    def validate(self, **kwargs): ...
    @abstractmethod
    def load(self, **kwargs): ...
```

### ğŸ” í‘œì¤€ ì‹¤í–‰ íë¦„

```
1ï¸âƒ£ API Fetch (EODHD)
2ï¸âƒ£ Pandera 1ì°¨ ê²€ì¦
3ï¸âƒ£ Soda Core 2ì°¨ ê²€ì¦ (DuckDB ê¸°ë°˜)
4ï¸âƒ£ ê²€ì¦ í†µê³¼ ì‹œ Data Lake ì €ì¥
5ï¸âƒ£ PostgreSQL ì ì¬
```

---

## ğŸ” Validator êµ¬ì¡°

| Validator                | ëŒ€ìƒ ë°ì´í„° | ê²€ì¦ ë„êµ¬          | ê²½ë¡œ                      |
| ------------------------ | ------ | -------------- | ----------------------- |
| **SymbolListValidator**  | ê±°ë˜ì†Œ ì¢…ëª© | Pandera        | validated/symbols       |
| **EquityPriceValidator** | ì£¼ê°€/ì‹œì„¸  | Pandera + Soda | validated/equity_prices |
| **FundamentalValidator** | í€ë”ë©˜í„¸   | Pandera + Soda | validated/fundamentals  |
| **DividendValidator**    | ë°°ë‹¹ê¸ˆ    | Pandera + Soda | validated/dividends     |
| **SplitValidator**       | ì•¡ë©´ë¶„í•    | Pandera + Soda | validated/splits        |

---

## ğŸ§ª Pandera ê²€ì¦ ì˜ˆì‹œ

### EquityPriceValidator

```python
return pa.DataFrameSchema(
    columns={
        "code": Column(str),
        "exchange_short_name": Column(str),
        "date": Column(str),
        "close": Column(float, Check(lambda s: s >= 0)),
        "volume": Column(float, nullable=True),
    },
    checks=[
        Check(lambda df: df["high"] >= df["low"], error="ê³ ê°€<ì €ê°€ ì˜¤ë¥˜")
    ],
)
```

### DividendValidator

```python
return pa.DataFrameSchema(
    columns={
        "code": Column(str),
        "exchange": Column(str),
        "date": Column(str),
        "dividend": Column(float, Check(lambda s: s >= 0)),
        "currency": Column(str, nullable=True),
        "unadjustedValue": Column(float, nullable=True),
    },
)
```

### SplitValidator

```python
return pa.DataFrameSchema(
    columns={
        "code": Column(str),
        "exchange": Column(str),
        "date": Column(str),
        "split": Column(str),
        "split_norm": Column(str),
    },
)
```

---

## ğŸ§  ì •ê·œí™” ë¡œì§ (Split ì „ìš©)

```python
df["split_norm"] = (
    df["split"]
    .fillna("")
    .astype(str)
    .str.replace(r"\\/", "/", regex=True)
    .str.replace(":", "/", regex=False)
    .str.replace(r"\s+", "", regex=True)
    .str.strip()
)
```

âš ï¸ `split_norm` ì»¬ëŸ¼ì€ **ì‚­ì œ ê¸ˆì§€**,
Soda ê²€ì¦(`like_regex`)ì—ì„œ ë°˜ë“œì‹œ ì°¸ì¡°ë©ë‹ˆë‹¤.

---

## ğŸ“Š Soda Core ê²€ì¦ ì˜ˆì‹œ

### splits_checks.yml

```yaml
checks for splits:
  - row_count > 0
  - missing_percent(code) = 0
  - missing_percent(exchange) = 0
  - missing_percent(date) = 0
  - missing_percent(split_norm) = 0
  - duplicate_count(code) = 0
  - failed rows:
      name: invalid_split_ratio
      samples limit: 10
      fail condition: split_norm not like_regex '^[0-9]+(\\.[0-9]+)?/[0-9]+(\\.[0-9]+)?$'
```

### dividends_checks.yml

```yaml
checks for dividends:
  - row_count > 0
  - missing_percent(code) = 0
  - missing_percent(exchange) = 0
  - missing_percent(date) = 0
  - avg(dividend) >= 0
  - duplicate_count(code) = 0
```

---

## ğŸ§± ê²€ì¦ ë‹¨ê³„ ìš”ì•½

```
Raw JSON ìˆ˜ì§‘
   â†“
Pandera ê²€ì¦
   â†“
Soda ê²€ì¦ (DuckDB SQL)
   â†“
exit_code=0 â†’ validated ê²½ë¡œ ì €ì¥
```

---

## ğŸ’¾ íŒŒì´í”„ë¼ì¸ë³„ êµ¬ì„± ìš”ì•½

| Pipeline            | ë°ì´í„°   | API                              | ê²€ì¦             | ê²°ê³¼ ì €ì¥                   |
| ------------------- | ----- | -------------------------------- | -------------- | ----------------------- |
| SymbolListPipeline  | ì¢…ëª©ë¦¬ìŠ¤íŠ¸ | `/api/exchange-symbol-list/{EX}` | Pandera        | validated/symbols       |
| EquityPricePipeline | ì‹œì„¸    | `/api/eod-bulk-last-day/{EX}`    | Pandera + Soda | validated/equity_prices |
| FundamentalPipeline | í€ë”ë©˜í„¸  | `/api/fundamentals/{TICKER}`     | Pandera + Soda | validated/fundamentals  |
| DividendPipeline    | ë°°ë‹¹ê¸ˆ   | `/api/dividends/{TICKER}`        | Pandera + Soda | validated/dividends     |
| SplitPipeline       | ì•¡ë©´ë¶„í•   | `/api/splits/{EX}`               | Pandera + Soda | validated/splits        |

---

## ğŸ§¾ ë¡œê·¸ ë° ì‹¤í–‰ ê´€ë¦¬

* ëª¨ë“  TaskëŠ” `pipeline_helper.run_and_log()`ìœ¼ë¡œ ë˜í•‘
* ê²°ê³¼ëŠ” PostgreSQL í…Œì´ë¸” `pipeline_task_log`ì— JSONBë¡œ ì €ì¥

```sql
CREATE TABLE pipeline_task_log (
  id SERIAL PRIMARY KEY,
  dag_id TEXT,
  task_id TEXT,
  run_time TIMESTAMP,
  status TEXT,
  result_info JSONB,
  error_message TEXT
);
```

ë¡œê·¸ ì˜ˆì‹œ:

```json
{
  "exchange_code": "KO",
  "trd_dt": "2025-10-20",
  "data_domain": "splits",
  "record_count": 1,
  "validated_path": "/data_lake/validated/splits/exchange_code=KO/trd_dt=2025-10-20/splits.parquet"
}
```

---

## ğŸš€ ìš´ì˜ ê·œì¹™

| í•­ëª©    | ê·œì¹™                          |
| ----- | --------------------------- |
| ì‹¤í–‰ ì‹œê°„ | ì¥ ë§ˆê° í›„ 2~3ì‹œê°„                |
| ì¬ì‹¤í–‰   | í•´ë‹¹ ë‚ ì§œ ë°ì´í„° ì‚­ì œ í›„ ì¬ì ì¬          |
| ì‹¤íŒ¨ ì‹œ  | Slack ì•Œë¦¼ ì˜ˆì •                 |
| ê²€ì¦    | Pandera â†’ Soda ìˆœì°¨ ê²€ì¦        |
| ëª¨ë‹ˆí„°ë§  | Soda exit_code ê¸°ë°˜ íƒœìŠ¤í¬ ìƒíƒœ ë°˜ì˜ |

---

## ğŸ”® í™•ì¥ ê³„íš

| í•­ëª©    | ë‚´ìš©                                              |
| ----- | ----------------------------------------------- |
| âœ… í˜„ì¬  | Symbol / Price / Fundamental / Dividend / Split |
| ğŸ”œ ì˜ˆì • | ETF Holdings, News Sentiment, Insider Trades    |
| ğŸ§© í™•ì¥ | Great Expectations ëŒ€ì‹œë³´ë“œ ì—°ë™                      |
| ğŸ“Š ìš´ì˜ | DuckDB + Soda SQL ê¸°ë°˜ QA ë¦¬í¬íŠ¸ ìë™í™”                 |

---

## ğŸ§© ì°¸ê³ : ì˜¤ë¥˜ ë° í•´ê²° íŒ¨í„´

| ì˜¤ë¥˜ ìœ í˜•                                      | ì›ì¸                       | í•´ê²°                         |
| ------------------------------------------ | ------------------------ | -------------------------- |
| `Referenced column not found`              | split_norm ì‚­ì œ í›„ Soda ì‹¤í–‰  | parquet ì €ì¥ ì‹œ split_norm ìœ ì§€ |
| `Skipping unsupported check configuration` | Soda êµ¬ë²„ì „ valid_format ì‚¬ìš© | `like_regex` ë¬¸ë²•ìœ¼ë¡œ êµì²´       |
| `invalid_split_ratio [FAILED]`             | ë¹„ì •ìƒ ê°’(`/`, ë¹ˆê°’ ë“±) ì¡´ì¬      | ì •ê·œí™” ë¡œì§ ê°•í™” ë° Null í•„í„°ë§       |
| Pandera `column not in dataframe`          | API í•„ë“œëª… ë¶ˆì¼ì¹˜              | schema ì»¬ëŸ¼ëª… ë™ê¸°í™” í•„ìš”          |
