## 🧭 전체 계층 구조 개요

| 계층                 | 버킷 예시                  | 주요 목적                          | 접근 주체                          |
| ------------------ | ---------------------- | ------------------------------ | ------------------------------ |
| **Data Lake**      | `s3://data-lake/`      | 원천(raw) + 검증(validated) 데이터 저장 | ETL 시스템 (Airflow)              |
| **Data Warehouse** | `s3://data-warehouse/` | 정제·표준화·조인된 중간 통합 데이터           | ETL + 데이터 엔지니어                 |
| **Data Mart**      | `s3://data-mart/`      | 분석·BI·API·Dashboard용 최종 데이터셋   | BI, Data Analyst, External API |

---

## 🧱 1️⃣ Data Lake 버킷 구조 (수집 + 품질검증)

```
s3://data-lake/
├── raw/                       # 원시 데이터 (API, 크롤링, 로그 등)
│   ├── equity_prices/
│   ├── fx_rates/
│   └── fundamentals/
│
└── validated/                 # 스키마 및 필드 검증 통과 데이터
    ├── equity_prices/
    ├── fx_rates/
    └── fundamentals/
```

📌 **특징**

* 데이터 소스 중심 구조
* JSONL / CSV 포맷 중심 (가공 전)
* ETL에서만 쓰기 가능 (읽기 금지)
* IAM 정책:

  * `etl-role`: write/read
  * `bi-role`: ❌ no access

---

## 🧱 2️⃣ Data Warehouse 버킷 구조 (정제 + 통합)

```
s3://data-warehouse/
├── staging/                    # validated → 변환 중간 결과
│   ├── equity_prices/
│   ├── fx_rates/
│   ├── fundamentals/
│   └── macro_indicators/
│
├── curated/                    # 표준화·조인된 통합 데이터
│   ├── financials/
│   │   ├── income_statement/
│   │   ├── balance_sheet/
│   │   └── ratios/
│   ├── market/
│   │   ├── equity_prices/
│   │   ├── fx_rates/
│   │   └── technical_indicators/
│   └── macro/
│       ├── gdp/
│       ├── inflation/
│       └── unemployment/
│
└── snapshot/                   # 시점 기준 백업/복구용
    ├── 2025-10-15/
    ├── 2025-10-16/
```

📌 **특징**

* 데이터 모델이 ‘업무도메인’ 중심 (Market, Financial, Macro 등)
* 포맷: Parquet (+ partition: exchange_code, date 등)
* 거버넌스 중심 계층 (Data Contract, Validation Metadata 포함)
* IAM 정책:

  * `etl-role`: read/write
  * `analyst-role`: read-only

---

## 🧱 3️⃣ Data Mart 버킷 구조 (소비 + 분석 중심)

```
s3://data-mart/
├── analytics/                  # BI / Dashboard / API Query
│   ├── daily_market_summary/
│   ├── portfolio_metrics/
│   ├── sector_analysis/
│   └── news_sentiment/
│
├── research/                   # 백테스트, 모델 학습용
│   ├── fundamental_features/
│   ├── macro_factors/
│   └── trading_signals/
│
└── exports/                    # 외부 서비스 연동 (CSV, API 등)
    ├── dashboards/
    └── partner_feeds/
```

📌 **특징**

* BI / ML / 외부 서비스가 직접 접근하는 계층
* 포맷: Parquet, CSV, Feather, Delta 등 혼합 가능
* 주로 “읽기 전용” 버킷 (ETL은 쓰기만 수행)
* IAM 정책:

  * `bi-role`: read-only
  * `partner-role`: export 디렉토리만 접근

---

## 🔄 데이터 흐름 (End-to-End)

```
           [EODHD, Macro API 등]
                       ↓
      ┌────────────────────────────────┐
      │        S3 Data Lake             │
      │ raw → validated                 │
      └────────────────────────────────┘
                       ↓ (Transform / Standardize)
      ┌────────────────────────────────┐
      │        S3 Data Warehouse        │
      │ staging → curated → snapshot   │
      └────────────────────────────────┘
                       ↓ (Aggregate / Feature)
      ┌────────────────────────────────┐
      │        S3 Data Mart             │
      │ analytics / research / export  │
      └────────────────────────────────┘
```

---

## 📊 파일 포맷 및 파티셔닝 표준

| 계층        | 포맷            | Partition Key            | 목적       |
| --------- | ------------- | ------------------------ | -------- |
| Lake      | JSONL / CSV   | exchange_code, trd_dt    | 수집 중심    |
| Warehouse | Parquet       | exchange_code, dt / year | 정제·조인 중심 |
| Mart      | Parquet / CSV | dt, sector, country      | 소비·분석 중심 |

---

## 🧩 권한 및 운영정책 요약

| 구분        | 권장 IAM 정책                                        | 권한 유형      | 주요 주체                         |
| --------- | ------------------------------------------------ | ---------- | ----------------------------- |
| Lake      | `etl-role: RW`, `bi-role: none`                  | Private    | ETL 시스템                       |
| Warehouse | `etl-role: RW`, `analyst-role: RO`               | Controlled | Data Engineer / Analyst       |
| Mart      | `etl-role: W`, `bi-role: RO`, `partner-role: RO` | Public(내부) | BI, API, External Integration |

---

## 💡 운영 팁

* **Airflow DAG 레벨에서 S3 Hook 연결 분리**

  ```python
  lake_conn_id = "aws_s3_lake"
  wh_conn_id = "aws_s3_warehouse"
  mart_conn_id = "aws_s3_mart"
  ```

* **메타데이터 관리 일원화**

  * 각 버킷 루트에 `metadata/` 디렉토리 두고
    `schema.json`, `last_updated.json`, `validation_log.json` 저장
  * 이후 Glue Catalog 또는 Iceberg 테이블에 매핑 가능

* **비용 최적화**

  * Lake: S3 Standard-IA (비정기 접근)
  * Warehouse: S3 Standard
  * Mart: S3 Intelligent-Tiering (분석용 잦은 조회)

---

## ✅ 결론 요약

| 계층                 | 버킷 예시                  | 주요 목적 | 데이터 포맷      | 접근자          |
| ------------------ | ---------------------- | ----- | ----------- | ------------ |
| **Data Lake**      | `s3://data-lake/`      | 수집/검증 | JSONL/CSV   | ETL만         |
| **Data Warehouse** | `s3://data-warehouse/` | 정제/통합 | Parquet     | ETL+Engineer |
| **Data Mart**      | `s3://data-mart/`      | 분석/소비 | Parquet/CSV | Analyst/BI   |

> 💬 **핵심 원칙**
>
> * Lake는 “원본 보존”,
> * Warehouse는 “데이터 표준화 및 통합”,
> * Mart는 “분석·소비 최적화”.
> * 각 버킷은 **서로 다른 IAM 정책**, **다른 라이프사이클 정책**, **다른 데이터 포맷**으로 운용하세요.
